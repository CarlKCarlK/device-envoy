//! A device abstraction for rectangular NeoPixel-style (WS2812) LED panel displays.
//!
//! See [`Led2dGenerated`] for a concrete generated-struct example and usage.
//!
//! Use [`led2d!`] for single-strip panels or [`led2d_from_strip!`](crate::led2d::led2d_from_strip)
//! when sharing a PIO with other devices.

#[cfg(not(feature = "host"))]
use crate::led_strip::{Current, Gamma};
#[cfg(not(feature = "host"))]
use crate::led2d;
#[cfg(not(feature = "host"))]
use crate::led2d::layout::LedLayout;

// 12×4 panel wired serpentine row-major (sample configuration)
#[cfg(not(feature = "host"))]
const LED_LAYOUT: LedLayout<48, 12, 4> = LedLayout::serpentine_row_major();

#[cfg(all(not(doc), not(feature = "host")))]
led2d! {
    Led2dGenerated,
    pio: PIO0,
    pin: PIN_3,
    dma: DMA_CH0,
    width: 12,
    height: 4,
    led_layout: LED_LAYOUT,
    max_current: Current::Unlimited,
    gamma: Gamma::Gamma2_2,
    max_frames: 16,
    font: Font3x4Trim,
}

#[cfg(doc)]
#[doc = concat!(
    "A NeoPixel-style (WS2812) LED panel generated by the [`led2d!`] or [`led2d_from_strip!`](crate::led2d::led2d_from_strip) macro.\n\n",
    "**This is a concrete example.** When you write your own [`led2d!`] or [`led2d_from_strip!`](crate::led2d::led2d_from_strip) invocation, the compiler generates \n",
    "a struct with *your chosen name* and your specified panel dimensions. \n",
    "Any struct generated by [`led2d!`] or [`led2d_from_strip!`](crate::led2d::led2d_from_strip) has the same interface and methods you see documented here.\n\n",
    "## Configuration\n\n",
    "Generated structs are specialized for their exact use case:\n\n",
    "- **Panel dimensions** — Set via the `width` and `height` parameters in your `led2d!` or `led2d_from_strip!` invocation.\n",
    "- **LED layout mapping** — Configured via `led_layout`.\n",
    "- **[PIO](crate#glossary) resource and [DMA](crate#glossary) channel** — Customized to the pins and channels you specify.\n",
    "- **Power limiting, gamma correction, and frame buffering** — Configured via `max_current`, `gamma`, and `max_frames`. See the [`led2d!`] or [`led2d_from_strip!`](crate::led2d::led2d_from_strip) macro documentation for complete details.\n",
    "- **Fonts** — Set via `font`.\n\n",
    "# Example: Quick Start with `led2d!`\n\n",
    "```rust,no_run\n",
    "# #![no_std]\n",
    "# #![no_main]\n",
    "# use panic_probe as _;\n",
    "# use embassy_executor::Spawner;\n",
    "use embassy_rp::init;\n",
    "use device_kit::led2d;\n",
    "use device_kit::led_strips;\n",
    "use device_kit::led_strip::{Current, Gamma, colors};\n\n",
    "led2d! {\n",
    "    pub led12x4,\n",
    "    pio: PIO0,\n",
    "    pin: PIN_3,\n",
    "    dma: DMA_CH1,\n",
    "    width: 12,\n",
    "    height: 4,\n",
    "    led_layout: serpentine_column_major,\n",
    "    max_current: Current::Milliamps(500),\n",
    "    gamma: Gamma::Linear,\n",
    "    max_frames: 32,\n",
    "    font: Font3x4Trim,\n",
    "}\n\n",
    "#[embassy_executor::main]\n",
    "async fn main(spawner: Spawner) {\n",
    "    let p = init(Default::default());\n",
    "    let led = Led12x4::new(p.PIN_3, p.PIO0, p.DMA_CH1, spawner).unwrap();\n",
    "    led.write_text(\"HI\", &[colors::RED]).await.unwrap();\n",
    "}\n",
    "```\n\n",
    "# Example: Multi-Strip with `led2d_from_strip!`\n\n",
    "```rust,no_run\n",
    "# #![no_std]\n",
    "# #![no_main]\n",
    "# use panic_probe as _;\n",
    "# use embassy_executor::Spawner;\n",
    "use embassy_rp::init;\n",
    "use embassy_time::Duration;\n",
    "use device_kit::led_strip::led_strips;\n",
    "use device_kit::led2d::led2d_from_strip;\n",
    "use device_kit::led_strip::{Current, Gamma, colors};\n",
    "use device_kit::pio_split;\n\n",
    "led_strips! {\n",
    "    pio: PIO1,\n",
    "    Led12x4Strips {\n",
    "        strip: {\n",
    "            pin: PIN_3,\n",
    "            len: 48,\n",
    "            max_current: Current::Milliamps(500),\n",
    "            gamma: Gamma::Linear,\n",
    "        }\n",
    "    }\n",
    "}\n\n",
    "led2d_from_strip! {\n",
    "    pub led12x4,\n",
    "    strip_type: StripLedStrip,\n",
    "    width: 12,\n",
    "    height: 4,\n",
    "    led_layout: serpentine_column_major,\n",
    "    max_frames: 32,\n",
    "    font: Font3x4Trim,\n",
    "}\n\n",
    "#[embassy_executor::main]\n",
    "async fn main(spawner: Spawner) {\n",
    "    let p = init(Default::default());\n",
    "    let (sm0, _sm1, _sm2, _sm3) = pio_split!(p.PIO1);\n",
    "    let strip = StripLedStrip::new(sm0, p.PIN_3, p.DMA_CH0, spawner).unwrap();\n",
    "    let led_12x4 = Led12x4::from_strip(strip, spawner).unwrap();\n",
    "    let led_12x4_static = Led12x4::new_static();\n\n",
    "    let mut frame = Led12x4::new_frame();\n",
    "    led_12x4.write_text_to_frame(\"HI!\", &[colors::CYAN, colors::MAGENTA, colors::YELLOW], &mut frame).unwrap();\n",
    "    led_12x4.write_frame(frame).await.unwrap();\n\n",
    "    let frame_duration = Duration::from_millis(300);\n",
    "    led_12x4.animate([\n",
    "        (Led12x4::new_frame(), frame_duration),\n",
    "        (Led12x4::new_frame(), frame_duration),\n",
    "    ]).await.unwrap();\n\n",
    "#    let _ = led_12x4_static;\n",
    "#    use core::future;\n",
    "    future::pending::<()>().await;\n",
    "}\n",
    "```\n\n",
    "See the [`led2d!`] or [`led2d_from_strip!`](crate::led2d::led2d_from_strip) macro documentation for all configuration options.\n",
)]
pub struct Led2dGenerated;

#[cfg(doc)]
/// Static resources for `Led2dGenerated`.
///
/// See the [struct-level example](Led2dGenerated) for usage.
pub struct Led2dGeneratedStatic {
    led2d_static: crate::led2d::Led2dStatic<48, 16>,
}

#[cfg(doc)]
/// Frame type for `Led2dGenerated`.
///
/// See the [struct-level example](Led2dGenerated) for usage.
pub type Led2dGeneratedFrame = crate::led2d::Frame<12, 4>;

#[cfg(doc)]
/// LED strip type generated by `led2d!` for this example.
///
/// See the [struct-level example](Led2dGenerated) for usage.
pub struct Led2dGeneratedLedStrip;

#[cfg(doc)]
impl Led2dGenerated {
    /// Number of columns in the display.
    pub const W: usize = 12;
    /// Number of columns in the display.
    pub const WIDTH: usize = 12;
    /// Number of rows in the display.
    pub const H: usize = 4;
    /// Number of rows in the display.
    pub const HEIGHT: usize = 4;
    /// Total number of LEDs (W * H).
    pub const N: usize = 48;
    /// Maximum animation frames supported for this panel.
    pub const MAX_FRAMES: usize = 16;

    /// Create static resources.
    ///
    /// See the [struct-level example](Self) for usage.
    #[must_use]
    pub const fn new_static() -> Led2dGeneratedStatic {
        Led2dGeneratedStatic {
            led2d_static: crate::led2d::Led2dStatic::new_static(),
        }
    }

    /// Create a new blank (all black) frame.
    ///
    /// See the [struct-level example](Self) for usage.
    #[must_use]
    pub const fn new_frame() -> Led2dGeneratedFrame {
        crate::led2d::Frame::new()
    }

    /// Create a new LED panel instance with automatic PIO setup.
    ///
    /// See the [struct-level example](Self) for usage.
    pub fn new(
        pin: embassy_rp::Peri<'static, embassy_rp::peripherals::PIN_3>,
        pio: embassy_rp::Peri<'static, embassy_rp::peripherals::PIO0>,
        dma: embassy_rp::Peri<'static, embassy_rp::peripherals::DMA_CH0>,
        spawner: embassy_executor::Spawner,
    ) -> crate::Result<Self> {
        let _ = (pin, pio, dma, spawner);
        Ok(Self)
    }

    /// Create a new LED panel instance from a strip.
    ///
    /// See the [struct-level example](Self) for usage.
    pub fn from_strip(
        led_strip: &'static Led2dGeneratedLedStrip,
        spawner: embassy_executor::Spawner,
    ) -> crate::Result<Self> {
        let _ = (led_strip, spawner);
        Ok(Self)
    }

    /// Render a fully defined frame to the display.
    ///
    /// See the [struct-level example](Self) for usage.
    pub async fn write_frame(&self, frame: Led2dGeneratedFrame) -> crate::Result<()> {
        let _ = frame;
        Ok(())
    }

    /// Loop through a sequence of animation frames.
    ///
    /// See the [struct-level example](Self) for usage.
    pub async fn animate(
        &self,
        frames: impl IntoIterator<Item = (Led2dGeneratedFrame, embassy_time::Duration)>,
    ) -> crate::Result<()> {
        let _ = frames;
        Ok(())
    }

    /// Render text into a frame using the configured font and spacing.
    ///
    /// See the [struct-level example](Self) for usage.
    pub fn write_text_to_frame(
        &self,
        text: &str,
        colors: &[smart_leds::RGB8],
        frame: &mut Led2dGeneratedFrame,
    ) -> crate::Result<()> {
        let _ = (text, colors, frame);
        Ok(())
    }

    /// Render text and display it on the LED panel.
    ///
    /// See the [struct-level example](Self) for usage.
    pub async fn write_text(&self, text: &str, colors: &[smart_leds::RGB8]) -> crate::Result<()> {
        let _ = (text, colors);
        Ok(())
    }
}
